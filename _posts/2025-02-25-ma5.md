---
title: "파밍"
categories:
  - Malware Analysis
tags:
  - 악성코드 분석
layout: archive
layout: single
author_profile: true
sidebar_main: true
toc: true
toc_sticky: true
toc_label: "목차"
---

# 파밍 악성코드 분석 보고서

## 악성코드 순서도
![image](https://github.com/user-attachments/assets/fc61ac08-b0db-4bf2-a139-d48fe6a2518a)

## 악성코드 동작과정
1. 패킹이 된 악성 코드를 매뉴얼 언패킹을 진행하여 패킹을 해제
2. sub_401966 실행, koreaautoup.bmp 파일 생성, 원본 악성 코드 Temp 경로 및 Common File 경로에 복사 한 뒤 원본 악성 코드 제거
3. Software\\Microsoft\\Windows\\CurrentVersion\\Run, Software\\Microsoft\\Windows\\CurrentVersion\\Internet Settings, Software\\Microsoft\\Internet Explorer\\Main\\Start Page `(www.naver.com)` 레지스트리 변조 (자동 업데이트, DNS 설정, 시작 페이지 설정 등을 제어)
4. sub_4026D8 실행, iexplorer를 사용하여 `http://kt.tobeuapk.com/lude.htm`l 웹사이트 실행
5. sub_4027EE 실행, `http://user.qzone.qq.com/1055869208`와 네트워크 통신 진행
6. 네트워크 통신 진행 시 HttpSendRequest를 통해 send를 보낸 뒤 버퍼에 악성 파일 다운로드
7. hosts, hosts.ics 파일 변조 후 자바 스크립트 코드를 웹 페이지에 삽입하여 금융 사이트에 접속 시 강제 리다이렉트 시키고 qq.com에서 파밍 수행(MITM)

## 악성코드 세부분석
● Detect it easy를 사용하여 파일을 확인해본 결과 PECompact를 사용하여 패킹이 되어있는 것을 확인할 수 있다.


[그림 1. Detect it easy 결과]

● PECompact로 패킹된 악성코드의 특징은 88 50 64 33C0 8908로 시작하는 것을 볼 수 있다.


[그림 2. PECompact 특징]

● 매뉴얼 언패킹을 진행하였으며, 보통의 패커들은 압축을 해제하기 전 온전한 OEP 주소를 저장한 뒤 압축이 풀릴 경우 해당 주소를 불러들이는데, 이때 초기 ESP주소를 이용하므로 이를 활용해 처음 ESP에 저장된 주소를 따라가 하드웨어 브레이크 포인트를 걸어 주었다.


[그림 3. esp에 저장된 주소 따라감]


[그림 4. 하드웨어 브레이크 포인트 지점]

● 브레이크 포인트 설정 후 계속 실행하다 보면 보통의 패커들과 동일하게 언패킹된 곳으로 이동하는 jmp 지점을 찾을 수 있다.


[그림 5. jmp 지점 확인]

● F7을 통해 jmp 지점으로 이동한 뒤 x32dbg에 내장되어있는 Scylla를 실행하고 순서대로 진행하면 아래와같이 SCY 파일이 생성된 것을 확인할 수 있다.


[그림 6. Scylla 실행 순서]


[그림 7. SCY 파일 생성 확인]

● 언패킹이 완료되었으므로 분석을 진행 해보면 매우 많은 함수들이 존재하며 Start에서 시작하는 것을 확인할 수 있다.


[그림 8. 파일 시작 부분 확인]

● sub_40968C -> sub_401079 -> sub_40108F로 진입하면 여러 함수들을 확인할 수 있는데 핵심적인 함수들은 아래와 같다.


[그림 9. sub_40108F]

● sub_401966을 살펴보면, 아래와 같이 현재 실행 중인 악성 코드의 경로를 가져오는 것을 확인할 수 있다.


[그림 10. 악성 코드 파일 경로 추출 함수 확인]


[그림 11. 추출된 악성 코드 경로 확인]

● 계속 진행해 보면, 아래와 같이 CommonFiles 환경 변수 경로를 추출하는 것도 확인할 수 있으며, 현재 실행 중인 악성 코드의 파일명도 추출하는 것을 확인할 수 있다.


[그림 12. CommonFiles 환경 변수 경로 추출 함수 확인]


[그림 13. 추출된 환경 변수 경로 확인]


[그림 14. 파밀명 추출 함수 확인]


[그림 15. 추출된 파일명 확인]

● 이 후, 환경 변수와 파일명을 합친 후 반환하는 것을 확인할 수 있다.


[그림 16. 여러 문자열을 하나의 버퍼에 합치는 함수 확인]


[그림 17. 반환 문자열 확인]

● 그 다음, koreaautoup.bmp라는 파일명을 추출한 뒤 생성하는 것을 확인할 수 있다.


[그림 18. koreaautoup.bmp 파일명 추출 함수]


[그림 19. koreaautoup.bmp 파일명 확인]


[그림 20. 파일생성 함수]


[그림 21. 생성된 파일 확인]

● 계속 진행해 보면, 레지스트리 키 문자열을 출력한 뒤 레지스트리를 설정하는 것을 확인할 수 있는데, 생성 함수의 2번째 입력값이 4이므로 레지스트리 키 값이 –2147483646(0x80000002)(HKEY_LOCAL_MACHINE)인 것을 확인할 수 있다.


[그림 22. 레지스트리 문자열 반환 1]


[그림 23. 반환된 레지스트리 문자열 1]


[그림 24. 레지스트리 생성 함수]


[그림 25. 레지스트리 키 생성 함수]


[그림 25. 입력값에 따른 레지스트리 키 반환]

● 이 후, 원본 악성 코드를 Common Files, Temp 디렉토리에 복사 후 원본 파일을 제거하는 것을 확인할 수 있다.


[그림 26. Common Files에 파일을 복사하는 함수]


[그림 27. 파일 복사 확인]


[그림 28. TemporaryFile 디렉토리 생성 및 원본 파일 복사, 제거 함수]


[그림 29. TemporaryFile 형태의 복사된 파일 확인]

● 이후로는 쭉 레지스트리 값을 추출하여 생성하는 것을 반복 한다. (레지스트리 생성 함수의 경우 위와 동일 sub_40A370)


[그림 30. 레지스트리 문자열 반환 2]


[그림 31. 반환된 레지스트리 문자열 2]


[그림 32. 레지스트리 문자열 반환 3]


[그림 33. 반환된 레지스트리 문자열 3]


[그림 34. 레지스트리 문자열 반환 4]


[그림 35. 반환된 레지스트리 문자열 4]


[그림 36. 레지스트리 문자열 반환 5]


[그림 37. 반환된 레지스트리 문자열 5]


[그림 38. 레지스트리 문자열 반환 6]


[그림 39. 반환된 레지스트리 문자열 6]


[그림 40. 레지스트리 문자열 반환 7]


[그림 41. 반환된 레지스트리 문자열 7]

● 다음으로 sub_4026D8을 살펴보면, ProgramFiles 환경 변수 경로를 가져온 뒤, `http://kt.tobeuapk.com/lude.html`를 가져오고, 위에서 확인한 sub_40186D함수를 통해 합친 뒤 익스플로러를 통해 실행하는 것을 확인할 수 있다. 

● 익스플로러 실행 함수의 경우 입력받은 a8의 값을 통해 실행한 윈도우의 창 표시 모드를 설정하는 것도 확인할 수 있다. (1(창 숨기기), 3(최소화된 창), 4(최대화된 창), 5(활성화되지 않은 창 표시), 6(최대화된 창 표시)) (여기선 1이므로 창을 숨겨 실행)


[그림 42. ProgramFiles 환경 변수 추출 함수]


[그림 43. ProgramFiles 환경 변수 확인]


[그림 44. url 추출 함수]


[그림 45. url 확인]


[그림 46. 반환된 최종 문자열]


[그림 47. 익스플로러 실행 함수]


[그림 48. 익스플로러 실행 함수 입력값 확인]


[그림 48. a8 값에 따라 창 표시 모드 설정]


[그림 48. 익스플로러 실행 결과 확인]

● 마지막으로 살펴볼 sub_4027EE 함수를 살펴보면, 파밍을 수행하는 악성 url 주소를 추출하는 것을 확인할 수 있다.


[그림 49. 데이터 처리, 변환, 계산 후 문자열을 반환하는 함수]


[그림 50. 반환된 악성 url 확인]

● 이 후, sub_40287F를 실행하며 이 함수에 포함된 sub_402BD0 함수에서 get 형식으로 user-agent는 Mozilla/4.0 (compatible; MSIE 9.0; Windows NT 6.1; 125LA; .NET CLR 2.0.50727; .NET CLR 3.0.04506.648; .NET CLR 3.5.21022)를 통해 `http://user.qzone.qq.com/1055869208`에 네트워크 연결을 수행하며, Referer: `http://user.qzone.qq.com/1055869208\r\nAccept: */*\r\nAccept-Language: zh-cn\r\nContent-Type: application/x-www-form-urlencoded`를 HttpSendRequest를 통해 보낸 뒤 파일을 버퍼에 읽어오는 것을 확인할 수 있다.


[그림 51. GET 확인]


[그림 52. user-agent 확인]


[그림 53. InternetOpenA 함수 확인]


[그림 54. InternetConnectA 함수 확인]


[그림 55. HttpOpenRequestA 함수 확인]


[그림 56. Send 문자열 확인]


[그림 57. HttpSendRequestA 함수 확인]


[그림 58. InternetReadFile 함수 확인]


[그림 59. http 응답 문자열 확인]


[그림 60. 버퍼에 저장된 파일 내용 확인]

● 이 후, hosts파일과 hosts.ics 파일을 변조시키는 작업 진행 후, javascript 코드를 삽입하여 금융 사이트 접속 시 파밍 사이트로 강제 리다이렉트 시키며, `qq.com`에서 파밍을 진행하는 것을 확인할 수 있다.


[그림 61. 변조할 금융 사이트 주소 확인 1]


[그림 62. 변조할 금융 사이트 주소 확인 2]


[그림 63. 변조할 금융 사이트 주소 확인 3]


[그림 64. 시스템 루트 디렉토리를 반환하는 함수]


[그림 65. 시스템 루트 디렉토리 확인]


[그림 66. hosts 디렉토리 확인]


[그림 67. 최종 hosts 경로 확인]


[그림 68. hosts.ics 디렉토리 확인]


[최종 hosts.ics 경로 확인]

● `“* @param {String} name ²ÎÊýµÄÃû³Æ.*/.var getParameter = function(url, name){.var r = new RegExp("(\\?| 금융 사이트..FFC028">.<meta name="baidu-site-verification" content="j44Osr0n9s" />.<script type="text/javascript">.(function(){try{if(parent!=self &&(parent.document.domain!=document.domain || (document.referrer &&!/^http(s)?:\/\/[.\w-]+\.qq\.com\//i.test(document.referrer)))){throw new Error("can't be iframed");}}catch(e){debugger;window.open(location.href, "_top");}})();../**.”` 위의 javascript 코드를 통해 금융 사이트 접속 시 파밍 사이트로 강제 리다이렉트 시키며 창을 무조건 최상단에 띄움 (iframe으로 접근 시 에러 메시지 출력)

● `“.Mozilla/4.0 (compatible; MSIE 9.0; Windows NT 6.1; 125LA; .NETCLR 2.0.50727; .NET CLR 3.0.04506.648; .NET CLR 3.5.21022).http=.https.HTTP/1.1.Referer:.Referer: ...Referer: .Accept:...Accept:*/*.Accept-Language:...Accept-Language: zh-cn.Content-Type:...Content-Type: application/x-www-form-urlencoded...Cookie: .Location:.Set-Cookie.;.Set-Cookie:.; ........@".#ÒýºÅ.:./.https://.http://.........ð?=deleted.=.www.woridank.com..www.wooribank.com..www.standardchartered.co.kr..www.shinhan.com..www.scfiirstdank.com..www.nonghyup.com..www.naver.com..www.kfcc.co.kr..www.keb.co.kr..www.kbstar.com..www.ibk.co.kr..www.hanadank.com..www.hanacbs.com..www.hanabank.com..www.epostdank.go.kr..www.epostbank.kr..www.epostbank.go.kr..www.epostbank.co.kr..www.daum.net..u.wooribank.com..standardchartered.co.kr..shinhan.com..scfirstdank.com..scfirstbank.com..pib.wooribank.com..open.wooridank.com..open.wooribank.com..open.shinhan.com..open.scfirstdank.com..open.nonghyup.com..open.kfcc.co.kr..open.keb.co.kr..open.kbstar.com..open.ibk.co.kr..open.hanadank.com..open.hanabank.com..online.keb.co.kr..odank1.kdstar.com..odank.kdstar.com..obank1.kbstar.com..obank.kbstar.com..nonghyup.com..naver.com..mydank.ibk.go.kr..mybank.ibk.co.kr..kiup.ibk.co.kr..kfcc.co.kr..keb.co.kr..kbstar.com..ibz.nonghyup.com..ibs.kfcc.co.kr..ibk.co.kr..ib.scfirstbank.com..hanmail.net..hanabank.com..epostdank.go.kr..epostbank.go.kr..edank.keb.co.kr..ebank.keb.co.kr..daum.net..danking.sinhan.com..danking.nonghuyp.com..bizbank.shinhan.com..banking.shinhan.com..banking.nonghyup.com..nate.com..www.nate.com..pann.nate.com..movie.nate.com..game.nate.com. .........0601"*/,,1........90VPQBJ..9AOFSBOP9BQ@9ELPQP........90VPQBJ..9AOFSBOP9BQ@9ELPQP.F@P# Copyright (c)1993-1999 Microsoft Corp...#..# This is a sample HOSTS file used by Microsoft TCP/IP for Windows...#..# This file contains the mappings of IP addresses to host names. Each..# entry should be kept on an individual line. The IP address should..# be placed in the first column followed by the corresponding host name...# The IP address and the host name should be separated by at least one..# space...#..# Additionally, comments (such as these) may be inserted on individual..# lines or following the machine name denoted by a '#' symbol...#..# For example:..#..#      102.54.94.97     rhino.acme.com          # source server..#       38.25.63.10     x.acme.com              # x client host....127.0.0.1 localhost...........AYAgent.aye................IEFrame........Edit........PQBM<FK.MEM....#...EQQM...@LLIAF@>.@LJ.GMD.MBKDVLR.”` hosts 및 hosts.ics 변조 문자열

● 정리해보면, 이 악성 코드는 koreaautoup.bmp 파일을 생성하며, Common Files 및 Temp 디렉토리에 자신을 복사한 후 원본 파일을 제거한다.

● 그리고 레지스트리를 악의적으로 조작하여 부팅 시 악성 코드가 자동으로 실행되게 하며 자동 업데이트 기능을 통해 악성 코드를 업데이트 시킬 수 있도록 수정한다.

● DNS 캐시를 조작하여 가짜 DNS 서버로 리디렉션을 가능하게 하며, 오래된 DNS 정보를 사용하게 하고 가짜 사이트인 `www.naver.com`을 시작 페이지로 설정한다.

● 이 후, iexplorer를 사용하여 http://kt.tobeuapk.com/lude.html 웹사이트 실행하고, 악의적인 사이트인 `http://user.qzone.qq.com/1055869208`과 네트워크 통신을 진행하면서 hosts 및 hosts.ics 파일 변조 및 금융 사이트 접속 시 파밍 사이트로 강제 리다이렉트를 수행하는 악성 코드이다.

● 가짜 금융 사이트에서 로그인 및 정보 입력 시 `qq.com`으로 정보가 유출된다.
